{{>/layout/main-header}}

<div class="container">
    <div class="my_auth_box">
        <div class="my_auth_form_box">
            <div class="my_auth_form_box_title">JSotry</div>
            <div class="my_error_box my_hidden">
            </div>
            <form action="/join" method="post" id="joinForm">
                <input id="username" class="my_auth_form_box_input" type="text" name="username" placeholder="ìœ ì €ë„¤ì„"
                       maxlength="20" value="" required/>
                <div id="usernameError" class="my_hidden" style="color: red">ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.</div>
                <div id="usernameSuccess" class="my_hidden" style="color: blue">ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.</div>

                <input id="password" class="my_auth_form_box_input" type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸"
                       maxlength="20" value="1234" required/>
                <input id="same-password" class="my_auth_form_box_input" type="password" name="" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                       maxlength="20" required/>
                <div id="errorText" style="color: red">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
                <div id="successText" style="color: blue">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</div>

                <div class="email-box d-flex">
                    <input class="my_auth_form_box_input" id="email" type="email" name="email" placeholder="ì´ë©”ì¼" maxlength="60"
                           value="compilemate@gmail.com"
                           required/>

<!--                    <a href="javascript:openModal('modal1');" class="close">(ìì„¸íˆë³´ê¸°)</a>-->
                    <button class="btn btn-outline-info btn-sm" type="button" id="emailAuthButton">ì¸ì¦í•˜ê¸°</button>
                    <!--

                                  <button class="btn btn-outline-success btn-sm" type="submit"
                                  onclick="emailCheck()">ì¸ì¦í•˜ê¸°</button>

                   <a href="javascript:openModal('modal1');" class="close">(ìì„¸íˆë³´ê¸°)</a>


                                  -->
                </div>

                <!-- ì—¬ê¸°ì— hidden inputì„ ì¶”ê°€í•˜ì„¸ìš” -->
                <input type="hidden" id="isEmailConfirmed" name="isEmailConfirmed" value="false">

                <button type="submit" id="joinBtn" class="my_secondary_btn">íšŒì›ê°€ì…</button>
            </form>

            <div class="my_auth_form_box_link">
                <div><a href="/login-form">ë¡œê·¸ì¸</a></div>
                <div><a href="/user/password-reset-form">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a></div>
            </div>
        </div>
    </div>
    <br/>
</div>

<!-- modal -->
<div id="authModal" class="modal modal1">
    <div class="modal-content modal1">
        <p style="font-size: 30px">ğŸ’Œ ë°œì†¡ ì™„ë£Œ ğŸ’Œ</p>
        <input type="text" id="authCodeText" placeholder="ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
        <div class="modal-buttons">
            <button id="cancelBtn">ì·¨ì†Œ</button>
            <button id="confirmBtn">í™•ì¸</button>
        </div>
    </div>
</div>

<script>


    function showModal() {
        $('#authCodeText').val('');
        $('#authModal').css('display', 'block');
    }

    // "ì¸ì¦í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ ë³´ë‚´ê¸° ëª¨ë‹¬ì°½ ë³´ì´ê¸°
    $('#emailAuthButton').on('click', function () {
        emailSendCode();
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì°½ ë‹«ê¸°
    $('#cancelBtn').on('click', function () {
        $('#authModal').css('display', 'none');
        // ì¸ì¦ ì½”ë“œ ì…ë ¥ë€ ì´ˆê¸°í™”
    });
    // ëª¨ë‹¬ì°½ ìŠ¤í¬ë¦½íŠ¸ ë





    <!-- ì´ë©”ì¼ ì£¼ì†Œë¡œ ë©”ì¼ ë³´ë‚´ê¸° -->
    function emailSendCode() {
        let email = encodeURIComponent($("#email").val());

        $.ajax({
            url: '/send-mail?email=' + email,  // AJAX URLê³¼ ì„œë²„ ë§¤í•‘ URL ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
            type: 'GET'

        }).done((res) => {
            console.log("Response:", res);
            emailCode = res.body;
            console.log("Received code:", emailCode);
            showModal();
        }).fail((res) => {
            alert("ì˜¤ë¥˜");
        });
    }


    // ì¸ì¦ë²ˆí˜¸ í™•ì¸ ë¡œì§
    let isEmailConfirmed = false;

    $("#confirmBtn").click(function () {
        let checkEmailCode = $("#authCodeText").val();

        $.ajax({
            url: '/check-email-code?emailCode=' + checkEmailCode,
            type: 'GET'
        }).done((res) => {
            if (res.body) {
                Swal.fire({
                    title: "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                    icon: "success",
                    button: "í™•ì¸"
                });
                $('#authModal').css('display', 'none');
                isEmailConfirmed = true; // ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ trueë¡œ ì„¤ì •
                $('#isEmailConfirmed').val('true'); // ì„œë²„ë¡œ ê°’ì„ ì „ì†¡í•˜ê¸° ìœ„í•´ ìˆ¨ê²¨ì§„ í•„ë“œì— ê°’ ì„¤ì •
            } else {
                Swal.fire({
                    title: "ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
                    icon: "warning",
                    confirmButtonText: "í™•ì¸"
                });
            }
        }).fail((res) => {
            alert("ì˜¤ë¥˜");
        });
    });


    // $("#confirmBtn").click(function () {
    //
    //     let checkEmailCode = $("#authCodeText").val();
    //     // console.log("ì…ë ¥ ì½”ë“œ " + checkCode);
    //
    //     $.ajax({
    //         url: '/check-email-code?emailCode=' + checkEmailCode,
    //         type: 'GET'
    //
    //     }).done((res)=>{
    //         if (res.body) {
    //             Swal.fire({
    //                 title: "ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
    //                 icon: "success",
    //                 button: "í™•ì¸"
    //             });
    //             $('#authModal').css('display', 'none');
    //             isEmailConfirmed = true; // ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìœ¼ë¯€ë¡œ trueë¡œ ì„¤ì •
    //
    //             // Hidden input fieldì— ê°’ì„ ì„¤ì •í•˜ì—¬ ì„œë²„ë¡œ ì „ì†¡ë  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
    //             $('#isEmailConfirmed').val('true');
    //
    //         } else {
    //             Swal.fire({
    //                 title: "ì¸ì¦ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
    //                 icon: "warning",
    //                 confirmButtonText: "í™•ì¸"
    //             });
    //
    //             $('#authModal').css('display', 'block');
    //         }
    //
    //     }).fail((res) => {
    //         alert("ì˜¤ë¥˜");
    //     });
    //
    // });

    // ì¸ì¦ë²ˆí˜¸ í™•ì¸ ë¡œì§ ë

    //ì´ë©”ì¼ì„ ë‹¤ë¥¸ê±¸ë¡œ ë°”ê¾¸ë©´ isEmailConfirmed ê°’ì„ ë‹¤ì‹œ falseë¡œ ë°”ê¿”ì¤˜ì•¼í•  ê²ƒ ê°™ìŒ
    $("#email").on("input", function () {
        isEmailConfirmed = false;
        // console.log("isEmailConfirmed " + isEmailConfirmed);
    });

    <!-- username ì¤‘ë³µ ì²´í¬ -->
    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— keyup ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
    $("#username").on('keyup', _.debounce(function () {
        console.log("Debounced event triggered"); // ë””ë°”ìš´ìŠ¤ í›„ ë¡œê·¸ ì¶œë ¥
        // ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ê°’ì„ ê°€ì ¸ì™€ì„œ ì½˜ì†”ì— ì¶œë ¥
        console.log($(this).val());
        let username = $(this).val();

        $.ajax({
            url: '/username-check?username=' + username,
            type: 'GET'

        }).done((res) => {
            console.log("Res " + JSON.stringify(res));

            // ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ í™•ì¸
            if (username === "") {
                // ì…ë ¥ë€ì´ ë¹ˆ ê²½ìš° í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
                $("#usernameError, #usernameSuccess").addClass("my_hidden").hide();
            } else if (res.body === "USER_EXIST") {
                showError(); // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            } else if (res.body === "USER_NO_EXIST") {
                showSuccess(); // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            }
        }).fail((res) => {
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        });
    }, 300));


    // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ì„±ê³µ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
    function showError() {
        $("#usernameError").removeClass("my_hidden").show();
        $("#usernameSuccess").addClass("my_hidden").hide();
    }

    // ì„±ê³µ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ê³  ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
    function showSuccess() {
        $("#usernameSuccess").removeClass("my_hidden").show();
        $("#usernameError").addClass("my_hidden").hide();
    }

    <!-- username ì¤‘ë³µ ì²´í¬ ë-->

    <!-- ë¹„ë°€ë²ˆí˜¸ ë™ì¼ ì²´í¬ -->
    $("#same-password").on("input", function () {
        let password = $("#password").val(); // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ê°’
        //console.log("íŒ¨ìŠ¤ì›Œë“œ = " + password);

        let confirmPassword = $("#same-password").val(); // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì…ë ¥ê°’
        //console.log("í™•ì¸ìš© = " + confirmPassword);


        if (password === confirmPassword) {
            $("#successText").show();
            $("#errorText").hide();
            $("#same-password").removeClass("error").addClass("correct");
            $("#joinBtn").css({
                "background-color": "rgb(255, 85, 68)",
                "color": "rgba(255,255,255,.8)"
            });


        } else if (confirmPassword === "") {
            $("#successText").hide();
            $("#errorText").hide();

        } else {
            $("#successText").hide();
            $("#errorText").show();
            $("#same-password").removeClass("correct").addClass("error");

            $("#joinBtn").css({
                "background-color": "",
                "color": ""
            });
        }
    });
    <!-- ë¹„ë°€ë²ˆí˜¸ ë™ì¼ ì²´í¬ ë-->

    // ì´ë©”ì¼ ì¸ì¦ ì•ˆë˜ë©´ ë§‰ê¸° + ë¹„ë²ˆì´ ë‹¤ë¥´ë©´ form ì œì¶œ ëª»í•˜ê²Œ ë§‰ì•„ë†“ìŒ
    $("#joinForm").on("submit", function (e) {
        // í¼ ë§‰ê¸°
        e.preventDefault();

        // ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€ í™•ì¸
        if (!isEmailConfirmed) {
            swal({
                text: "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                icon: "warning",
                button: "í™•ì¸"
            });
            return; // ì´ë©”ì¼ ì¸ì¦ì´ ì•ˆëœ ê²½ìš° í¼ ì œì¶œ ë§‰ê¸°
        }

        // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
        let password = $("#password").val();
        let confirmPassword = $("#same-password").val();

        if (password !== confirmPassword || confirmPassword === "") {
            swal({
                text: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
                icon: "warning",
                button: "í™•ì¸"
            });
        } else {
            // AJAX ìš”ì²­ìœ¼ë¡œ í¼ ì œì¶œ
            $.ajax({
                url: $(this).attr("action"), // "/join"
                type: $(this).attr("method"), // "POST"
                data: $(this).serialize(), // í¼ ë°ì´í„° ì§ë ¬í™”
                success: function (response) {
                    if (response.body === 200) {
                        // ì„±ê³µ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        window.location.href = "/"; // ë¦¬ë‹¤ì´ë ‰íŠ¸í•  ë©”ì¸ í˜ì´ì§€ URL
                    } else {
                        swal({
                            text: response.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
                            icon: "warning",
                            button: "í™•ì¸"
                        });
                    }
                },
                error: function (xhr, status, error) {
                    swal({
                        text: "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.",
                        icon: "error",
                        button: "í™•ì¸"
                    });
                }
            });
        }
    });


    // $("#joinForm").on("submit", function (e) {
    //     // í¼ ë§‰ê¸°
    //     e.preventDefault();
    //
    //     // ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€ í™•ì¸
    //     if (!isEmailConfirmed) {
    //         swal({
    //             text: "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.",
    //             icon: "warning",
    //             button: "í™•ì¸"
    //         });
    //         return; // ì´ë©”ì¼ ì¸ì¦ì´ ì•ˆëœ ê²½ìš° í¼ ì œì¶œ ë§‰ê¸°
    //     }
    //
    //     // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
    //     let password = $("#password").val();
    //     let confirmPassword = $("#same-password").val();
    //
    //     if (password !== confirmPassword || confirmPassword === "") {
    //         swal({
    //             text: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
    //             icon: "warning",
    //             button: "í™•ì¸"
    //         });
    //     } else {
    //         // í¼ì„ ì œì¶œ
    //         this.submit();
    //     }
    // });

    // $("#joinForm").on("submit", function (e) {
    //     //í¼ ë§‰ê¸°
    //     e.preventDefault();
    //
    //     console.log("1");
    //
    //
    //
    //     // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
    //     let password = $("#password").val();
    //     //console.log("íŒ¨ìŠ¤ì›Œë“œ = " + password);
    //
    //     let confirmPassword = $("#same-password").val();
    //     //console.log("í™•ì¸ìš© = " + confirmPassword);
    //
    //     if (password !== confirmPassword) {
    //         e.preventDefault();
    //
    //         swal({
    //             text: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
    //             icon: "warning",
    //             button: "í™•ì¸"
    //         });
    //
    //     } else if (confirmPassword === "") {
    //         e.preventDefault();
    //
    //         swal({
    //             text: "ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”",
    //             icon: "warning",
    //             button: "í™•ì¸"
    //         });
    //     }
    //     // íŒ¨ìŠ¤ì›Œë“œ ìœ íš¨ì„± ê²€ì‚¬
    // });
    //



</script>

{{>/layout/footer}}